---
- id: github-bjw-s-labs-renovate
  execute-command: /config/github-renovate-operator.sh
  pass-arguments-to-command:
    - # job name
      source: string
      name: bjw-s-labs
    - # namespace
      source: string
      name: renovate
    - # project
      source: payload
      name: repository.full_name
    - # Renovate Operator webhook URL
      source: string
      name: http://renovate-operator-webhook.renovate.svc.cluster.local:8082
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger only for the bjw-s-labs organization
        match:
          type: value
          value: bjw-s-labs
          parameter:
            source: payload
            name: organization.login
      - or:
          - # Trigger on GitHub Issue edits
            and:
              - match:
                  type: value
                  value: issues
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: edited
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: open
                  parameter:
                    source: payload
                    name: issue.state
              - match:
                  type: value
                  value: Renovate Dashboard
                  parameter:
                    source: payload
                    name: issue.title
          - # Trigger on GitHub Pull Request edits
            and:
              - match:
                  type: value
                  value: pull_request
                  parameter:
                    source: header
                    name: x-github-event
              - match:
                  type: value
                  value: edited
                  parameter:
                    source: payload
                    name: action
              - match:
                  type: value
                  value: open
                  parameter:
                    source: payload
                    name: pull_request.state
              - match:
                  type: value
                  value: lab-assistant[bot]
                  parameter:
                    source: payload
                    name: pull_request.user.login
- id: github-bjw-s-labs-home-ops-doco
  trigger-rule:
    and:
      - # Validate the webhook secret
        match:
          type: payload-hmac-sha1
          secret: >-
            {{ getenv "GITHUB_WEBHOOK_SECRET" | js }}
          parameter:
            source: header
            name: x-hub-signature
      - # Trigger on pushes to main branch of bjw-s-labs/home-ops repo
        and:
          - match:
              type: value
              value: push
              parameter:
                source: header
                name: x-github-event
          - match:
              type: value
              value: bjw-s-labs/home-ops
              parameter:
                source: payload
                name: repository.full_name
          - match:
              type: value
              value: refs/heads/main
              parameter:
                source: payload
                name: ref
  execute-command: /config/github-push-doco.sh
  pass-arguments-to-command:
    - # ref
      source: payload
      name: ref
    - # sha before
      source: payload
      name: before
    - # sha after
      source: payload
      name: after
    - # repository
      source: payload
      name: repository.full_name
    - # pusher name
      source: payload
      name: pusher.name
    - # pusher email
      source: payload
      name: pusher.email
    - # Doco webhook URL
      source: string
      name: http://gladius.bjw-s.internal:8080/v1/webhook

- id: radarr-pushover
  execute-command: /config/radarr-pushover.sh
  pass-arguments-to-command:
    - source: entire-payload

- id: sonarr-pushover
  execute-command: /config/sonarr-pushover.sh
  pass-arguments-to-command:
    - source: entire-payload
