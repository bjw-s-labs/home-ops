---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: go2rtc
spec:
  chartRef:
    kind: OCIRepository
    name: go2rtc
  interval: 30m
  values:
    configMaps:
      config:
        data:
          go2rtc.yaml: |-
            log:
              output: stdout
              level: debug

            api:
              listen: :1984
              origin: "*"

            rtsp:
              listen: :8554

            webrtc:
              listen: :8555
              candidates:
                - 10.1.1.133:8555
                - stun:8555
              ice_servers:
                - urls:
                    - stun:stun.cloudflare.com:3478

            streams:
              attic_office_3d_printer_front:
                - ffmpeg:${RTSP_PATHS_KIDS_SOURCE}
                - ffmpeg:attic_office_3d_printer_front#audio=opus
                - ffmpeg:attic_office_3d_printer_front#video=mjpeg
              driveway_front_door:
                - ffmpeg:rtsp://scrypted.{{ .Release.Namespace }}.svc.cluster.local:34136/8472285c9f0c0dd8
                - ffmpeg:driveway_front_door#audio=opus
                - ffmpeg:driveway_front_door#video=mjpeg
    controllers:
      go2rtc:
        pod:
          securityContext:
            fsGroup: 2000
            fsGroupChangePolicy: OnRootMismatch
            runAsGroup: 2000
            runAsUser: 2000
        containers:
          app:
            image:
              repository: ghcr.io/alexxit/go2rtc
              tag: 1.9.10
            envFrom:
              - secretRef:
                  name: go2rtc-secret
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 512Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
    service:
      app:
        ports:
          api:
            port: 1984
            primary: true
          rtsp:
            port: 8554
          webrtc-tcp:
            port: 8555
            protocol: TCP
          webrtc-udp:
            port: 8555
            protocol: UDP
    persistence:
      config:
        type: configMap
        identifier: config
        advancedMounts:
          go2rtc:
            app:
              - path: /config/go2rtc.yaml
                subPath: go2rtc.yaml
    route:
      app:
        hostnames:
          - go2rtc.bjw-s.dev
        parentRefs:
          - name: envoy-internal
            namespace: network
            sectionName: https
