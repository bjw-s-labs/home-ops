#################################################################################################################
# Create an object store user for access to the s3 endpoint.
#################################################################################################################
---
apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: ceph-bucket-backups
  namespace: rook-ceph
spec:
  bucketName: backups
  storageClassName: ceph-bucket
  additionalConfig:
    maxObjects: "100000"
    maxSize: "500G"
# ---
# apiVersion: ceph.rook.io/v1
# kind: CephObjectStoreUser
# metadata:
#   name: cluster-1-backup
#   namespace: rook-ceph # namespace:cluster
# spec:
#   store: ceph-objectstore
#   displayName: "Cluster-1 Backups"
#   # Quotas set on the user
#   quotas:
#     maxBuckets: 15
#     maxSize: 500G
#     maxObjects: 100000
#   # Additional permissions given to the user
#   capabilities:
#     user: "*"
#     bucket: "*"
#     metadata: "*"
#     usage: "*"
#     zone: "*"
#   # If the CephObjectStoreUser is created in a namespace other than the Rook cluster namespace,
#   # specify the namespace where the cluster and object store are found.
#   # "allowUsersInNamespaces" must include this namespace to enable this feature.
#   # clusterNamespace: rook-ceph
---
apiVersion: v1
kind: Service
metadata:
  name: rook-ceph-rgw-backups-service
  namespace: rook-ceph
  labels:
    app: rook-ceph-rgw
    rook_cluster: rook-ceph
    rook_object_store: ceph-objectstore
  annotations:
    external-dns.alpha.kubernetes.io/hostname: "backups.s3.${CLUSTER_NAME}.${INGRESS_DOMAIN}"
    io.cilium/lb-ipam-ips: ${LB_INGRESS_BACKUPS_BUCKET}
spec:
  ports:
  - name: rgw
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: rook-ceph-rgw
    rook_cluster: rook-ceph
    rook_object_store: ceph-objectstore
  sessionAffinity: None
  type: LoadBalancer
