---
fullnameOverride: prometheus

coreDns:
  enabled: true

kubeApiServer:
  enabled: true

kubeControllerManager:
  enabled: false
  endpoints:
    - 10.200.1.109                    # cp1
    - 10.200.1.108                    # cp2
    - 10.200.1.111                    # cp3
  service:
    enabled: true
    port: 2379
    targetPort: 2379

kubeEtcd:
  enabled: false
  endpoints:
    - 10.200.1.109                    # cp1
    - 10.200.1.108                    # cp2
    - 10.200.1.111                    # cp3
  service:
    enabled: true
    port: 2381
    targetPort: 2381
    
kubelet:
  enabled: true
  serviceMonitor:
    metricRelabelings:
      - action: replace
        sourceLabels:
          - node
        targetLabel: instance

# Disabled since kubeProxy is disabled in my talos config. 
# I think due to me using HAProxy externally
kubeProxy:
  enabled: false
  endpoints:
    - 10.200.1.109                    # cp1
    - 10.200.1.108                    # cp2
    - 10.200.1.111                    # cp3

# Need to add port info, helm chart complains about 
kubeScheduler:
  enabled: false
  endpoints:
    - 10.200.1.109                    # cp1
    - 10.200.1.108                    # cp2
    - 10.200.1.111                    # cp3

kubeStateMetrics:
  enabled: true
kube-state-metrics:
  metricLabelsAllowlist:
    - "persistentvolumeclaims=[*]"
  prometheus:
    monitor:
      enabled: true
      relabelings:
        - action: replace
          regex: (.*)
          replacement: $1
          sourceLabels:
            - __meta_kubernetes_pod_node_name
          targetLabel: kubernetes_node
  resources:
    requests:
      cpu: 15m
      memory: 127M
    limits:
      memory: 153M

prometheusOperator:
  # Setting this option to 0 to disable cpu limits
  # see https://github.com/prometheus-operator/prometheus-operator/blob/master/cmd/operator/main.go#L175
  configReloaderCpu: 0

grafana:
  enabled: false
  forceDeployDashboards: true
  sidecar:
    dashboards:
      multicluster:
        global:
          enabled: true

prometheus-node-exporter:
  fullnameOverride: node-exporter
  prometheus:
    monitor:
      enabled: true
      relabelings:
        - action: replace
          regex: (.*)
          replacement: $1
          sourceLabels:
            - __meta_kubernetes_pod_node_name
          targetLabel: kubernetes_node
        # - action: replace
        #   regex: (.*)
        #   replacement: $1
        #   sourceLabels:
        #     - __address__
        #   targetLabel: kubernetes_node
