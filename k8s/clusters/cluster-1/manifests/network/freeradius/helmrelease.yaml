---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: freeradius
  namespace: network
spec:
  interval: 15m
  chart:
    spec:
      chart: freeradius
      version: 3.2.0
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: startechnica-charts
        namespace: flux-system

  values:
    image:
      repository: freeradius/freeradius-server
      tag: "3.2.0"
      pullPolicy: IfNotPresent
      debug: false

    env:
      TZ: "${TIMEZONE}"
      FREERADIUS__INSTANCE_NAME: FREE-RADIUS
      # FREERADIUS__PORT: &port 8686
      FREERADIUS__APPLICATION_URL: &host-cluster "radius.${CLUSTER_NAME}.${INGRESS_DOMAIN}"
      FREERADIUS__LOG_LEVEL: info

    # FreeRADIUS architecture (`standalone` or `replication`)
    architecture: standalone

    auth:
      # Admin User
      clientUser: ${FREERADIUS_USERNAME}
      clientUserPassword: ${FREERADIUS_PASSWORD}

    replicaCount: 3

    podSecurityContext:
      enabled: true
      runAsUser: 568
      # runAsGroup: 100
      fsGroup: 568
      # supplementalGroups:
      #   - 34
      #   - 100
      # fsGroupChangePolicy: "OnRootMismatch"

    containerSecurityContext:
      enabled: true
      capabilities:
        add:
          - SYS_PTRACE
      runAsUser: 568
      runAsNonRoot: true

    persistence:
      enabled: true
      existingClaim: free-radius-config

    volumePermissions:
      # Enable init container that changes the owner/group of the PV mount point to `runAsUser:fsGroup`
      enabled: true

    service:
      ports:
        auth: 1812
        acct: 1813
        coa: 3799
        radsec: 2083
        status: 18121
      loadBalancerIP: ${LB_FREERADIUS}

    ingress:
      enabled: true
      ingressClassName: "traefik"
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-production
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.middlewares: network-chain-external@kubernetescrd      
      path: /
      extraRules:
      - host: *host-cluster

    resources:
      requests:
        memory: "250M"
      limits:
        memory: "1000M"
