---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: zigbee2mqtt
  namespace: home-automation
spec:
  dependsOn:
    - name: emqx
      namespace: home-automation
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controller:
      type: statefulset
      annotations:
        reloader.stakater.com/auto: "true"
    image:
      repository: ghcr.io/koenkk/zigbee2mqtt
      tag: 1.32.2

    env:
      TZ: "${TIMEZONE}"
      ZIGBEE2MQTT_DATA: /data
      # DEBUG: "zigbee-herdsman*"
      ZIGBEE2MQTT__INSTANCE_NAME: Zigbee2MQTT
      ZIGBEE2MQTT__PORT: &port 8080
      ZIGBEE2MQTT__APPLICATION_URL: &host "zigbee2mqtt.${CLUSTER_NAME}.${INGRESS_DOMAIN}"
      ZIGBEE2MQTT__LOG_LEVEL: info

    service:
      main:
        ports:
          http:
            port: *port

    persistence:
      data:
        enabled: true
        existingClaim: zigbee2mqtt-data

    ingress:
      main:
        enabled: true
        ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
          # external-dns.alpha.kubernetes.io/target: ingress.${INGRESS_DOMAIN}
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
          traefik.ingress.kubernetes.io/router.middlewares: network-chain-external@kubernetescrd

        hosts:
          - host: *host
            paths:
              - path: /

        tls:
          - secretName: tls.zigbee2mqtt
            hosts:
              - *host

    config:
      mqtt:
        base_topic: zigbee2mqtt
        server: "mqtt://mqtt.${INGRESS_DOMAIN}"
        user: ${MQTT_ZIGBEE2MQTT_USERNAME}
        password: ${MQTT_ZIGBEE2MQTT_PASSWORD}

      homeassistant: true

      device_options:
        retain: true

      permit_join: false

      serial:
        port: "tcp://10.10.100.10:6638"
        # port: "tcp://zigbee-gateway.iot.${INGRESS_DOMAIN}:6638"

      advanced:
        log_output:
          - console
        network_key:
          - 95
          - 127
          - 73
          - 119
          - 59
          - 169
          - 49
          - 50
          - 96
          - 72
          - 42
          - 246
          - 182
          - 104
          - 11
          - 41
        pan_id: 6752

      # Both of these need to be enabled for the webui
      frontend:
        port: 8080

    resources:
      requests:
        memory: 128Mi
      limits:
        memory: 192Mi
